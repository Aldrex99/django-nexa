{# feedback/job_feedbacks.html #} {% extends "base.html" %} {% block content %}
<h1>
  Feedbacks pour : {{ job.job_title }} <span id="feedback-average"></span>
</h1>

<div class="filter-container">
  <label>
    Note min :
    <input type="number" id="min-rating" placeholder="1-5" min="1" max="5" />
  </label>
  <button id="filter-btn">Filtrer</button>
</div>

<div class="feedback-container">
  <section id="feedback-list" data-job-id="{{ job.id }}">
    <p>Chargement…</p>
  </section>

  <section>
    <h2>Ajouter un feedback</h2>
    <form id="feedback-form">
      <label for="rating">Note (1-5) :</label>
      <input type="number" name="rating" min="1" max="5" required id="rating" />
      <label for="comment">Commentaire :</label>
      <textarea
        name="comment"
        rows="3"
        required
        id="comment"
        placeholder="Votre avis sur cette offre de travail..."
      ></textarea>
      <button type="submit">Envoyer</button>
    </form>
  </section>
</div>

<script>
  const TOKEN = "{{ request.user.auth_token.key }}";

  document.addEventListener("DOMContentLoaded", () => {
    const listDiv = document.getElementById("feedback-list");
    const jobId = listDiv.dataset.jobId;
    const form = document.getElementById("feedback-form");
    const averageSpan = document.getElementById("feedback-average");
    const filterBtn = document.getElementById("filter-btn");
    const minInput = document.getElementById("min-rating");

    function apiFetch(url, opts = {}) {
      opts.headers = {
        Authorization: `Token ${TOKEN}`,
        ...(opts.headers || {}),
      };
      return fetch(url, opts);
    }

    function loadFeedbacks() {
      let url = `/api/feedback/feedbacks?job=${jobId}&ordering=-rating`;
      const min = minInput.value;
      if (min) {
        // ajoute un filtre rating__gte
        url += `&rating__gte=${encodeURIComponent(min)}`;
      }
      apiFetch(url)
        .then((r) => r.json())
        .then((json) => {
          listDiv.innerHTML =
            (json || [])
              .map(
                (fb) => `
            <div class="feedback">
              <strong>${fb.rating}/5</strong> - ${
                  fb.author?.username || "Anonyme"
                }
              <em>${new Date(fb.created_at).toLocaleString()}</em>
              <p>${fb.comment}</p>
            </div>
          `
              )
              .join("") || "<p>Aucun feedback.</p>";

          if (json.length > 0) {
            const totalRating = json.reduce((sum, fb) => sum + fb.rating, 0);
            const averageRating = (totalRating / json.length).toFixed(2);
            averageSpan.textContent = `(${averageRating} / 5)`;
          } else {
            averageSpan.textContent = "";
          }
        })
        .catch(
          (e) => (
            console.error(e),
            (listDiv.innerHTML = "<p>Erreur de chargement.</p>")
          )
        );
    }

    filterBtn.addEventListener("click", loadFeedbacks);

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const data = new FormData(form);
      data.append("job_id", jobId);

      apiFetch("/api/feedback/feedbacks/", {
        method: "POST",
        body: data,
      })
        .then((res) => {
          if (!res.ok) throw new Error("Erreur création");
          form.reset();
          loadFeedbacks();
        })
        .catch((err) => (console.error(err), alert(err)));
    });

    loadFeedbacks();
  });
</script>

<style>
  .filter-container {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    background-color: #333;
    border-radius: 5px;
    padding: 20px;
  }

  .feedback-container {
    display: flex;
    width: 100%;
    gap: 20px;
  }

  .feedback-container section {
    flex: 1;
    background-color: #333;
    padding: 20px;
    border-radius: 5px;
  }

  .feedback {
    padding: 10px;
    margin-bottom: 10px;
    background-color: gray;
    border-radius: 5px;
  }

  .feedback p .feedback strong {
    display: block;
    margin-bottom: 5px;
  }

  .feedback em {
    display: block;
    font-size: 0.9em;
    margin-bottom: 5px;
  }

  #feedback-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
</style>
{% endblock %}
